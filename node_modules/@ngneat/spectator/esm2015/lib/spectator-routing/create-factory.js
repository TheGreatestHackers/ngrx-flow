import { NgZone } from '@angular/core';
import { async, TestBed } from '@angular/core/testing';
import { ActivatedRoute, Router } from '@angular/router';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { overrideComponentIfProviderOverridesSpecified, overrideModules } from '../spectator/create-factory';
import { addMatchers } from '../core';
import { isType } from '../types';
import { ActivatedRouteStub } from './activated-route-stub';
import { initialRoutingModule } from './initial-module';
import { getRoutingDefaultOptions } from './options';
import { SpectatorRouting } from './spectator-routing';
/**
 * @publicApi
 */
export function createRoutingFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getRoutingDefaultOptions({ component: typeOrOptions })
        : getRoutingDefaultOptions(typeOrOptions);
    const moduleMetadata = initialRoutingModule(options);
    beforeEach(async(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
        overrideComponentIfProviderOverridesSpecified(options);
        TestBed.compileComponents();
    }));
    return (overrides) => {
        const defaults = {
            props: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, providers } = Object.assign(Object.assign({}, defaults), overrides);
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        const { params, queryParams, data, fragment, url, root, parent, children, firstChild } = Object.assign(Object.assign({}, options), overrides);
        TestBed.overrideProvider(ActivatedRoute, {
            useValue: new ActivatedRouteStub({ params, queryParams, data, fragment, url, root, parent, children, firstChild })
        });
        const ngZone = TestBed.inject ? TestBed.inject(NgZone) : TestBed.get(NgZone);
        return ngZone.run(() => {
            const spectator = createSpectatorRouting(options, props);
            spectator.router.initialNavigation();
            if (options.detectChanges && detectChanges) {
                spectator.detectChanges();
            }
            return spectator;
        });
    };
}
function createSpectatorRouting(options, props) {
    const fixture = TestBed.createComponent(options.component);
    const debugElement = fixture.debugElement;
    const component = setProps(fixture.componentInstance, props);
    /**
     * Back compatibility, angular under 9 version doesnt have a inject function
     */
    if (!TestBed.inject) {
        return new SpectatorRouting(fixture, debugElement, component, TestBed.get(Router), TestBed.get(ActivatedRoute));
    }
    return new SpectatorRouting(fixture, debugElement, component, TestBed.inject(Router), TestBed.inject(ActivatedRoute));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL25ldGFuZWxiYXNhbC93d3cvc3BlY3RhdG9yL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvIiwic291cmNlcyI6WyJsaWIvc3BlY3RhdG9yLXJvdXRpbmcvY3JlYXRlLWZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFrQixNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXpELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEtBQUssY0FBYyxNQUFNLGFBQWEsQ0FBQztBQUM5QyxPQUFPLEVBQXNCLDZDQUE2QyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pJLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDdEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsd0JBQXdCLEVBQTJCLE1BQU0sV0FBVyxDQUFDO0FBRTlFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBYXZEOztHQUVHO0FBQ0gsTUFBTSxVQUFVLG9CQUFvQixDQUFJLGFBQW1EO0lBQ3pGLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFDbkMsQ0FBQyxDQUFDLHdCQUF3QixDQUFJLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxDQUFDO1FBQzNELENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUU1QyxNQUFNLGNBQWMsR0FBRyxvQkFBb0IsQ0FBSSxPQUFPLENBQUMsQ0FBQztJQUV4RCxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRTtRQUNwQixXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUIsT0FBTyxDQUFDLHNCQUFzQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRS9DLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV6Qiw2Q0FBNkMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV2RCxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRUosT0FBTyxDQUFDLFNBQXdDLEVBQUUsRUFBRTtRQUNsRCxNQUFNLFFBQVEsR0FBaUM7WUFDN0MsS0FBSyxFQUFFLEVBQUU7WUFDVCxhQUFhLEVBQUUsSUFBSTtZQUNuQixTQUFTLEVBQUUsRUFBRTtTQUNkLENBQUM7UUFFRixNQUFNLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsbUNBQVEsUUFBUSxHQUFLLFNBQVMsQ0FBRSxDQUFDO1FBRTFFLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDakMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQWtCLEVBQUUsRUFBRTtnQkFDdkMsT0FBTyxDQUFDLGdCQUFnQixDQUFFLFFBQWdCLENBQUMsT0FBTyxFQUFFLFFBQWUsQ0FBQyxDQUFDO1lBQ3ZFLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxNQUFNLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsbUNBQVEsT0FBTyxHQUFLLFNBQVMsQ0FBRSxDQUFDO1FBRXRILE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUU7WUFDdkMsUUFBUSxFQUFFLElBQUksa0JBQWtCLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDO1NBQ25ILENBQUMsQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFTLE9BQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFcEYsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUNyQixNQUFNLFNBQVMsR0FBRyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFekQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBRXJDLElBQUksT0FBTyxDQUFDLGFBQWEsSUFBSSxhQUFhLEVBQUU7Z0JBQzFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUMzQjtZQUVELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUksT0FBNkMsRUFBRSxLQUFrQjtJQUNsRyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMzRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDO0lBRTFDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFN0Q7O09BRUc7SUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUNuQixPQUFPLElBQUksZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7S0FDakg7SUFFRCxPQUFPLElBQUksZ0JBQWdCLENBQ3pCLE9BQU8sRUFDUCxZQUFZLEVBQ1osU0FBUyxFQUNULE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQ3RCLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFrQyxDQUNoRSxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZpZGVyLCBUeXBlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFzeW5jLCBUZXN0QmVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS90ZXN0aW5nJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuXG5pbXBvcnQgeyBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgKiBhcyBjdXN0b21NYXRjaGVycyBmcm9tICcuLi9tYXRjaGVycyc7XG5pbXBvcnQgeyBTcGVjdGF0b3JPdmVycmlkZXMsIG92ZXJyaWRlQ29tcG9uZW50SWZQcm92aWRlck92ZXJyaWRlc1NwZWNpZmllZCwgb3ZlcnJpZGVNb2R1bGVzIH0gZnJvbSAnLi4vc3BlY3RhdG9yL2NyZWF0ZS1mYWN0b3J5JztcbmltcG9ydCB7IGFkZE1hdGNoZXJzIH0gZnJvbSAnLi4vY29yZSc7XG5pbXBvcnQgeyBpc1R5cGUgfSBmcm9tICcuLi90eXBlcyc7XG5cbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlU3R1YiB9IGZyb20gJy4vYWN0aXZhdGVkLXJvdXRlLXN0dWInO1xuaW1wb3J0IHsgaW5pdGlhbFJvdXRpbmdNb2R1bGUgfSBmcm9tICcuL2luaXRpYWwtbW9kdWxlJztcbmltcG9ydCB7IGdldFJvdXRpbmdEZWZhdWx0T3B0aW9ucywgU3BlY3RhdG9yUm91dGluZ09wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgUm91dGVPcHRpb25zIH0gZnJvbSAnLi9yb3V0ZS1vcHRpb25zJztcbmltcG9ydCB7IFNwZWN0YXRvclJvdXRpbmcgfSBmcm9tICcuL3NwZWN0YXRvci1yb3V0aW5nJztcbmltcG9ydCB7IFNweU9iamVjdCB9IGZyb20gJy4uL21vY2snO1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IHR5cGUgU3BlY3RhdG9yUm91dGluZ092ZXJyaWRlczxDPiA9IFNwZWN0YXRvck92ZXJyaWRlczxDPiAmIFJvdXRlT3B0aW9ucztcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCB0eXBlIFNwZWN0YXRvclJvdXRpbmdGYWN0b3J5PEM+ID0gKG9wdGlvbnM/OiBTcGVjdGF0b3JSb3V0aW5nT3ZlcnJpZGVzPEM+KSA9PiBTcGVjdGF0b3JSb3V0aW5nPEM+O1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJvdXRpbmdGYWN0b3J5PEM+KHR5cGVPck9wdGlvbnM6IFR5cGU8Qz4gfCBTcGVjdGF0b3JSb3V0aW5nT3B0aW9uczxDPik6IFNwZWN0YXRvclJvdXRpbmdGYWN0b3J5PEM+IHtcbiAgY29uc3Qgb3B0aW9ucyA9IGlzVHlwZSh0eXBlT3JPcHRpb25zKVxuICAgID8gZ2V0Um91dGluZ0RlZmF1bHRPcHRpb25zPEM+KHsgY29tcG9uZW50OiB0eXBlT3JPcHRpb25zIH0pXG4gICAgOiBnZXRSb3V0aW5nRGVmYXVsdE9wdGlvbnModHlwZU9yT3B0aW9ucyk7XG5cbiAgY29uc3QgbW9kdWxlTWV0YWRhdGEgPSBpbml0aWFsUm91dGluZ01vZHVsZTxDPihvcHRpb25zKTtcblxuICBiZWZvcmVFYWNoKGFzeW5jKCgpID0+IHtcbiAgICBhZGRNYXRjaGVycyhjdXN0b21NYXRjaGVycyk7XG4gICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKG1vZHVsZU1ldGFkYXRhKTtcblxuICAgIG92ZXJyaWRlTW9kdWxlcyhvcHRpb25zKTtcblxuICAgIG92ZXJyaWRlQ29tcG9uZW50SWZQcm92aWRlck92ZXJyaWRlc1NwZWNpZmllZChvcHRpb25zKTtcblxuICAgIFRlc3RCZWQuY29tcGlsZUNvbXBvbmVudHMoKTtcbiAgfSkpO1xuXG4gIHJldHVybiAob3ZlcnJpZGVzPzogU3BlY3RhdG9yUm91dGluZ092ZXJyaWRlczxDPikgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRzOiBTcGVjdGF0b3JSb3V0aW5nT3ZlcnJpZGVzPEM+ID0ge1xuICAgICAgcHJvcHM6IHt9LFxuICAgICAgZGV0ZWN0Q2hhbmdlczogdHJ1ZSxcbiAgICAgIHByb3ZpZGVyczogW11cbiAgICB9O1xuXG4gICAgY29uc3QgeyBkZXRlY3RDaGFuZ2VzLCBwcm9wcywgcHJvdmlkZXJzIH0gPSB7IC4uLmRlZmF1bHRzLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkge1xuICAgICAgcHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBQcm92aWRlcikgPT4ge1xuICAgICAgICBUZXN0QmVkLm92ZXJyaWRlUHJvdmlkZXIoKHByb3ZpZGVyIGFzIGFueSkucHJvdmlkZSwgcHJvdmlkZXIgYXMgYW55KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcGFyYW1zLCBxdWVyeVBhcmFtcywgZGF0YSwgZnJhZ21lbnQsIHVybCwgcm9vdCwgcGFyZW50LCBjaGlsZHJlbiwgZmlyc3RDaGlsZCB9ID0geyAuLi5vcHRpb25zLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIFRlc3RCZWQub3ZlcnJpZGVQcm92aWRlcihBY3RpdmF0ZWRSb3V0ZSwge1xuICAgICAgdXNlVmFsdWU6IG5ldyBBY3RpdmF0ZWRSb3V0ZVN0dWIoeyBwYXJhbXMsIHF1ZXJ5UGFyYW1zLCBkYXRhLCBmcmFnbWVudCwgdXJsLCByb290LCBwYXJlbnQsIGNoaWxkcmVuLCBmaXJzdENoaWxkIH0pXG4gICAgfSk7XG4gICAgY29uc3Qgbmdab25lID0gKDxhbnk+VGVzdEJlZCkuaW5qZWN0ID8gVGVzdEJlZC5pbmplY3QoTmdab25lKSA6IFRlc3RCZWQuZ2V0KE5nWm9uZSk7XG5cbiAgICByZXR1cm4gbmdab25lLnJ1bigoKSA9PiB7XG4gICAgICBjb25zdCBzcGVjdGF0b3IgPSBjcmVhdGVTcGVjdGF0b3JSb3V0aW5nKG9wdGlvbnMsIHByb3BzKTtcblxuICAgICAgc3BlY3RhdG9yLnJvdXRlci5pbml0aWFsTmF2aWdhdGlvbigpO1xuXG4gICAgICBpZiAob3B0aW9ucy5kZXRlY3RDaGFuZ2VzICYmIGRldGVjdENoYW5nZXMpIHtcbiAgICAgICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNwZWN0YXRvcjtcbiAgICB9KTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU3BlY3RhdG9yUm91dGluZzxDPihvcHRpb25zOiBSZXF1aXJlZDxTcGVjdGF0b3JSb3V0aW5nT3B0aW9uczxDPj4sIHByb3BzPzogUGFydGlhbDxDPik6IFNwZWN0YXRvclJvdXRpbmc8Qz4ge1xuICBjb25zdCBmaXh0dXJlID0gVGVzdEJlZC5jcmVhdGVDb21wb25lbnQob3B0aW9ucy5jb21wb25lbnQpO1xuICBjb25zdCBkZWJ1Z0VsZW1lbnQgPSBmaXh0dXJlLmRlYnVnRWxlbWVudDtcblxuICBjb25zdCBjb21wb25lbnQgPSBzZXRQcm9wcyhmaXh0dXJlLmNvbXBvbmVudEluc3RhbmNlLCBwcm9wcyk7XG5cbiAgLyoqXG4gICAqIEJhY2sgY29tcGF0aWJpbGl0eSwgYW5ndWxhciB1bmRlciA5IHZlcnNpb24gZG9lc250IGhhdmUgYSBpbmplY3QgZnVuY3Rpb25cbiAgICovXG4gIGlmICghVGVzdEJlZC5pbmplY3QpIHtcbiAgICByZXR1cm4gbmV3IFNwZWN0YXRvclJvdXRpbmcoZml4dHVyZSwgZGVidWdFbGVtZW50LCBjb21wb25lbnQsIFRlc3RCZWQuZ2V0KFJvdXRlciksIFRlc3RCZWQuZ2V0KEFjdGl2YXRlZFJvdXRlKSk7XG4gIH1cblxuICByZXR1cm4gbmV3IFNwZWN0YXRvclJvdXRpbmcoXG4gICAgZml4dHVyZSxcbiAgICBkZWJ1Z0VsZW1lbnQsXG4gICAgY29tcG9uZW50LFxuICAgIFRlc3RCZWQuaW5qZWN0KFJvdXRlciksXG4gICAgVGVzdEJlZC5pbmplY3QoQWN0aXZhdGVkUm91dGUpIGFzIFNweU9iamVjdDxBY3RpdmF0ZWRSb3V0ZVN0dWI+XG4gICk7XG59XG4iXX0=