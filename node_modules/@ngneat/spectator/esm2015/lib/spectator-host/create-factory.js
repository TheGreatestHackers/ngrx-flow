import { async, TestBed } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { BrowserDynamicTestingModule } from '@angular/platform-browser-dynamic/testing';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { overrideComponentIfProviderOverridesSpecified, overrideModules } from '../spectator/create-factory';
import { addMatchers } from '../core';
import { isType } from '../types';
import { nodeByDirective } from '../internals/node-by-directive';
import { initialSpectatorWithHostModule } from './initial-module';
import { getSpectatorHostDefaultOptions } from './options';
import { SpectatorHost } from './spectator-host';
export function createHostFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getSpectatorHostDefaultOptions({ component: typeOrOptions })
        : getSpectatorHostDefaultOptions(typeOrOptions);
    const moduleMetadata = initialSpectatorWithHostModule(options);
    beforeEach(async(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
        overrideComponentIfProviderOverridesSpecified(options);
    }));
    return (template, overrides) => {
        const defaults = { props: {}, hostProps: {}, detectChanges: true, providers: [] };
        const { detectChanges, props, hostProps, providers } = Object.assign(Object.assign({}, defaults), overrides);
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        TestBed.overrideModule(BrowserDynamicTestingModule, {
            set: {
                entryComponents: moduleMetadata.entryComponents
            }
        }).overrideComponent(options.host, {
            set: { template: template || options.template }
        });
        const spectator = createSpectatorHost(options, props, hostProps);
        if (options.detectChanges && detectChanges) {
            spectator.detectChanges();
        }
        return spectator;
    };
}
function createSpectatorHost(options, props, hostProps) {
    const hostFixture = TestBed.createComponent(options.host);
    const debugElement = hostFixture.debugElement.query(By.directive(options.component)) || hostFixture.debugElement;
    const debugNode = hostFixture.debugElement.queryAllNodes(nodeByDirective(options.component))[0];
    if (!debugNode) {
        throw new Error(`Cannot find component/directive ${options.component} in host template ðŸ˜”`);
    }
    const hostComponent = setProps(hostFixture.componentInstance, hostProps);
    const component = setProps(debugNode.injector.get(options.component), props);
    return new SpectatorHost(hostComponent, hostFixture.debugElement, hostFixture.nativeElement, hostFixture, debugElement, component, debugElement.nativeElement);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL25ldGFuZWxiYXNhbC93d3cvc3BlY3RhdG9yL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvIiwic291cmNlcyI6WyJsaWIvc3BlY3RhdG9yLWhvc3QvY3JlYXRlLWZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDL0MsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFFeEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sS0FBSyxjQUFjLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sRUFBRSw2Q0FBNkMsRUFBRSxlQUFlLEVBQXNCLE1BQU0sNkJBQTZCLENBQUM7QUFDakksT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUdqRSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRSxPQUFPLEVBQUUsOEJBQThCLEVBQXdCLE1BQU0sV0FBVyxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQW1DakQsTUFBTSxVQUFVLGlCQUFpQixDQUF1QixhQUFtRDtJQUN6RyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQ25DLENBQUMsQ0FBQyw4QkFBOEIsQ0FBTyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsQ0FBQztRQUNwRSxDQUFDLENBQUMsOEJBQThCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFF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YSxDQUMzQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZpZGVyLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBhc3luYywgVGVzdEJlZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBCeSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljL3Rlc3RpbmcnO1xuXG5pbXBvcnQgeyBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgKiBhcyBjdXN0b21NYXRjaGVycyBmcm9tICcuLi9tYXRjaGVycyc7XG5pbXBvcnQgeyBvdmVycmlkZUNvbXBvbmVudElmUHJvdmlkZXJPdmVycmlkZXNTcGVjaWZpZWQsIG92ZXJyaWRlTW9kdWxlcywgU3BlY3RhdG9yT3ZlcnJpZGVzIH0gZnJvbSAnLi4vc3BlY3RhdG9yL2NyZWF0ZS1mYWN0b3J5JztcbmltcG9ydCB7IGFkZE1hdGNoZXJzIH0gZnJvbSAnLi4vY29yZSc7XG5pbXBvcnQgeyBpc1R5cGUgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBub2RlQnlEaXJlY3RpdmUgfSBmcm9tICcuLi9pbnRlcm5hbHMvbm9kZS1ieS1kaXJlY3RpdmUnO1xuXG5pbXBvcnQgeyBIb3N0Q29tcG9uZW50IH0gZnJvbSAnLi9ob3N0LWNvbXBvbmVudCc7XG5pbXBvcnQgeyBpbml0aWFsU3BlY3RhdG9yV2l0aEhvc3RNb2R1bGUgfSBmcm9tICcuL2luaXRpYWwtbW9kdWxlJztcbmltcG9ydCB7IGdldFNwZWN0YXRvckhvc3REZWZhdWx0T3B0aW9ucywgU3BlY3RhdG9ySG9zdE9wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgU3BlY3RhdG9ySG9zdCB9IGZyb20gJy4vc3BlY3RhdG9yLWhvc3QnO1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IHR5cGUgU3BlY3RhdG9ySG9zdEZhY3Rvcnk8QywgSD4gPSA8SFA+KFxuICB0ZW1wbGF0ZTogc3RyaW5nLFxuICBvdmVycmlkZXM/OiBTcGVjdGF0b3JIb3N0T3ZlcnJpZGVzPEMsIEgsIEhQPlxuKSA9PiBTcGVjdGF0b3JIb3N0PEMsIEggJiAoSG9zdENvbXBvbmVudCBleHRlbmRzIEggPyBIUCA6IHVua25vd24pPjtcblxuLyoqXG4gKiBAcHVibGljQXBpXG4gKi9cbmV4cG9ydCB0eXBlIFByZXNldFNwZWN0YXRvckhvc3RGYWN0b3J5PEMsIEg+ID0gPEhQPihcbiAgdGVtcGxhdGU/OiBzdHJpbmcsXG4gIG92ZXJyaWRlcz86IFNwZWN0YXRvckhvc3RPdmVycmlkZXM8QywgSCwgSFA+XG4pID0+IFNwZWN0YXRvckhvc3Q8QywgSCAmIChIb3N0Q29tcG9uZW50IGV4dGVuZHMgSCA/IEhQIDogdW5rbm93bik+O1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTcGVjdGF0b3JIb3N0T3ZlcnJpZGVzPEMsIEgsIEhQPiBleHRlbmRzIFNwZWN0YXRvck92ZXJyaWRlczxDPiB7XG4gIGhvc3RQcm9wcz86IEhvc3RDb21wb25lbnQgZXh0ZW5kcyBIID8gSFAgOiBQYXJ0aWFsPEg+O1xufVxuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUhvc3RGYWN0b3J5PEMsIEggPSBIb3N0Q29tcG9uZW50PihcbiAgb3B0aW9uczogU3BlY3RhdG9ySG9zdE9wdGlvbnM8QywgSD4gJiB7IHRlbXBsYXRlOiBzdHJpbmcgfVxuKTogUHJlc2V0U3BlY3RhdG9ySG9zdEZhY3Rvcnk8QywgSD47XG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUhvc3RGYWN0b3J5PEMsIEggPSBIb3N0Q29tcG9uZW50Pih0eXBlT3JPcHRpb25zOiBUeXBlPEM+IHwgU3BlY3RhdG9ySG9zdE9wdGlvbnM8QywgSD4pOiBTcGVjdGF0b3JIb3N0RmFjdG9yeTxDLCBIPjtcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVIb3N0RmFjdG9yeTxDLCBIID0gSG9zdENvbXBvbmVudD4odHlwZU9yT3B0aW9uczogVHlwZTxDPiB8IFNwZWN0YXRvckhvc3RPcHRpb25zPEMsIEg+KTogU3BlY3RhdG9ySG9zdEZhY3Rvcnk8QywgSD4ge1xuICBjb25zdCBvcHRpb25zID0gaXNUeXBlKHR5cGVPck9wdGlvbnMpXG4gICAgPyBnZXRTcGVjdGF0b3JIb3N0RGVmYXVsdE9wdGlvbnM8QywgSD4oeyBjb21wb25lbnQ6IHR5cGVPck9wdGlvbnMgfSlcbiAgICA6IGdldFNwZWN0YXRvckhvc3REZWZhdWx0T3B0aW9ucyh0eXBlT3JPcHRpb25zKTtcblxuICBjb25zdCBtb2R1bGVNZXRhZGF0YSA9IGluaXRpYWxTcGVjdGF0b3JXaXRoSG9zdE1vZHVsZTxDLCBIPihvcHRpb25zKTtcblxuICBiZWZvcmVFYWNoKGFzeW5jKCgpID0+IHtcbiAgICBhZGRNYXRjaGVycyhjdXN0b21NYXRjaGVycyk7XG4gICAgVGVzdEJlZC5jb25maWd1cmVUZXN0aW5nTW9kdWxlKG1vZHVsZU1ldGFkYXRhKTtcblxuICAgIG92ZXJyaWRlTW9kdWxlcyhvcHRpb25zKTtcblxuICAgIG92ZXJyaWRlQ29tcG9uZW50SWZQcm92aWRlck92ZXJyaWRlc1NwZWNpZmllZChvcHRpb25zKTtcbiAgfSkpO1xuXG4gIHJldHVybiA8SFA+KHRlbXBsYXRlPzogc3RyaW5nLCBvdmVycmlkZXM/OiBTcGVjdGF0b3JIb3N0T3ZlcnJpZGVzPEMsIEgsIEhQPikgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRzOiBTcGVjdGF0b3JIb3N0T3ZlcnJpZGVzPEMsIEgsIEhQPiA9IHsgcHJvcHM6IHt9LCBob3N0UHJvcHM6IHt9IGFzIGFueSwgZGV0ZWN0Q2hhbmdlczogdHJ1ZSwgcHJvdmlkZXJzOiBbXSB9O1xuICAgIGNvbnN0IHsgZGV0ZWN0Q2hhbmdlcywgcHJvcHMsIGhvc3RQcm9wcywgcHJvdmlkZXJzIH0gPSB7IC4uLmRlZmF1bHRzLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkge1xuICAgICAgcHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBQcm92aWRlcikgPT4ge1xuICAgICAgICBUZXN0QmVkLm92ZXJyaWRlUHJvdmlkZXIoKHByb3ZpZGVyIGFzIGFueSkucHJvdmlkZSwgcHJvdmlkZXIgYXMgYW55KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIFRlc3RCZWQub3ZlcnJpZGVNb2R1bGUoQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlLCB7XG4gICAgICBzZXQ6IHtcbiAgICAgICAgZW50cnlDb21wb25lbnRzOiBtb2R1bGVNZXRhZGF0YS5lbnRyeUNvbXBvbmVudHNcbiAgICAgIH1cbiAgICB9KS5vdmVycmlkZUNvbXBvbmVudChvcHRpb25zLmhvc3QsIHtcbiAgICAgIHNldDogeyB0ZW1wbGF0ZTogdGVtcGxhdGUgfHwgb3B0aW9ucy50ZW1wbGF0ZSB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBzcGVjdGF0b3IgPSBjcmVhdGVTcGVjdGF0b3JIb3N0KG9wdGlvbnMsIHByb3BzLCBob3N0UHJvcHMpO1xuXG4gICAgaWYgKG9wdGlvbnMuZGV0ZWN0Q2hhbmdlcyAmJiBkZXRlY3RDaGFuZ2VzKSB7XG4gICAgICBzcGVjdGF0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIHJldHVybiBzcGVjdGF0b3I7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVNwZWN0YXRvckhvc3Q8QywgSCwgSFA+KFxuICBvcHRpb25zOiBSZXF1aXJlZDxTcGVjdGF0b3JIb3N0T3B0aW9uczxDLCBIPj4sXG4gIHByb3BzPzogUGFydGlhbDxDPixcbiAgaG9zdFByb3BzPzogSFBcbik6IFNwZWN0YXRvckhvc3Q8QywgSCAmIEhQPiB7XG4gIGNvbnN0IGhvc3RGaXh0dXJlID0gVGVzdEJlZC5jcmVhdGVDb21wb25lbnQob3B0aW9ucy5ob3N0KTtcbiAgY29uc3QgZGVidWdFbGVtZW50ID0gaG9zdEZpeHR1cmUuZGVidWdFbGVtZW50LnF1ZXJ5KEJ5LmRpcmVjdGl2ZShvcHRpb25zLmNvbXBvbmVudCkpIHx8IGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudDtcbiAgY29uc3QgZGVidWdOb2RlID0gaG9zdEZpeHR1cmUuZGVidWdFbGVtZW50LnF1ZXJ5QWxsTm9kZXMobm9kZUJ5RGlyZWN0aXZlKG9wdGlvbnMuY29tcG9uZW50KSlbMF07XG5cbiAgaWYgKCFkZWJ1Z05vZGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIGNvbXBvbmVudC9kaXJlY3RpdmUgJHtvcHRpb25zLmNvbXBvbmVudH0gaW4gaG9zdCB0ZW1wbGF0ZSDwn5iUYCk7XG4gIH1cblxuICBjb25zdCBob3N0Q29tcG9uZW50ID0gc2V0UHJvcHMoaG9zdEZpeHR1cmUuY29tcG9uZW50SW5zdGFuY2UsIGhvc3RQcm9wcyk7XG4gIGNvbnN0IGNvbXBvbmVudCA9IHNldFByb3BzKGRlYnVnTm9kZS5pbmplY3Rvci5nZXQob3B0aW9ucy5jb21wb25lbnQpLCBwcm9wcyk7XG5cbiAgcmV0dXJuIG5ldyBTcGVjdGF0b3JIb3N0KFxuICAgIGhvc3RDb21wb25lbnQsXG4gICAgaG9zdEZpeHR1cmUuZGVidWdFbGVtZW50LFxuICAgIGhvc3RGaXh0dXJlLm5hdGl2ZUVsZW1lbnQsXG4gICAgaG9zdEZpeHR1cmUsXG4gICAgZGVidWdFbGVtZW50LFxuICAgIGNvbXBvbmVudCxcbiAgICBkZWJ1Z0VsZW1lbnQubmF0aXZlRWxlbWVudFxuICApO1xufVxuIl19