import { async, TestBed } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { BrowserDynamicTestingModule } from '@angular/platform-browser-dynamic/testing';
import { setProps } from '../internals/query';
import * as customMatchers from '../matchers';
import { addMatchers } from '../core';
import { isType } from '../types';
import { nodeByDirective } from '../internals/node-by-directive';
import { initialSpectatorDirectiveModule } from './initial-module';
import { getSpectatorDirectiveDefaultOptions } from './options';
import { SpectatorDirective } from './spectator-directive';
import { overrideModules } from '../spectator/create-factory';
export function createDirectiveFactory(typeOrOptions) {
    const options = isType(typeOrOptions)
        ? getSpectatorDirectiveDefaultOptions({ directive: typeOrOptions })
        : getSpectatorDirectiveDefaultOptions(typeOrOptions);
    const moduleMetadata = initialSpectatorDirectiveModule(options);
    beforeEach(async(() => {
        addMatchers(customMatchers);
        TestBed.configureTestingModule(moduleMetadata);
        overrideModules(options);
    }));
    return (template, overrides) => {
        const defaults = {
            props: {},
            hostProps: {},
            detectChanges: true,
            providers: []
        };
        const { detectChanges, props, hostProps, providers } = Object.assign(Object.assign({}, defaults), overrides);
        if (providers && providers.length) {
            providers.forEach((provider) => {
                TestBed.overrideProvider(provider.provide, provider);
            });
        }
        TestBed.overrideModule(BrowserDynamicTestingModule, {
            set: {
                entryComponents: moduleMetadata.entryComponents
            }
        }).overrideComponent(options.host, {
            set: { template: template || options.template }
        });
        if (options.directiveProviders.length || options.directiveMocks.length) {
            TestBed.overrideDirective(options.directive, {
                set: { providers: [...options.directiveProviders, ...options.directiveMocks.map(p => options.mockProvider(p))] }
            });
        }
        const spectator = createSpectatorDirective(options, props, hostProps);
        if (options.detectChanges && detectChanges) {
            spectator.detectChanges();
        }
        return spectator;
    };
}
function createSpectatorDirective(options, props, hostProps) {
    const hostFixture = TestBed.createComponent(options.host);
    const debugElement = hostFixture.debugElement.query(By.directive(options.directive)) || hostFixture.debugElement;
    const debugNode = hostFixture.debugElement.queryAllNodes(nodeByDirective(options.directive))[0];
    if (!debugNode) {
        throw new Error(`Cannot find directive ${options.directive} in host template ðŸ˜”`);
    }
    const hostComponent = setProps(hostFixture.componentInstance, hostProps);
    const directive = setProps(debugNode.injector.get(options.directive), props);
    return new SpectatorDirective(hostComponent, hostFixture, hostFixture.debugElement, directive, debugElement.nativeElement);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL25ldGFuZWxiYXNhbC93d3cvc3BlY3RhdG9yL3Byb2plY3RzL3NwZWN0YXRvci9zcmMvIiwic291cmNlcyI6WyJsaWIvc3BlY3RhdG9yLWRpcmVjdGl2ZS9jcmVhdGUtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUV4RixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUMsT0FBTyxLQUFLLGNBQWMsTUFBTSxhQUFhLENBQUM7QUFDOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR2xDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVqRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsbUNBQW1DLEVBQTZCLE1BQU0sV0FBVyxDQUFDO0FBQzNGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQXdDOUQsTUFBTSxVQUFVLHNCQUFzQixDQUNwQyxhQUF3RDtJQUV4RCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQ25DLENBQUMsQ0FBQyxtQ0FBbUMsQ0FBTyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsQ0FBQztRQUN6RSxDQUFDLENBQUMsbUNBQW1DLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFdkQsTUFB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QVEsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDekUsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU3RSxPQUFPLElBQUksa0JBQWtCLENBQUMsYUFBYSxFQUFFLFdBQVcsRUFBRSxXQUFXLENBQUMsWUFBWSxFQUFFLFNBQVMsRUFBRSxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDN0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZpZGVyLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBhc3luYywgVGVzdEJlZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5pbXBvcnQgeyBCeSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuaW1wb3J0IHsgQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlci1keW5hbWljL3Rlc3RpbmcnO1xuXG5pbXBvcnQgeyBzZXRQcm9wcyB9IGZyb20gJy4uL2ludGVybmFscy9xdWVyeSc7XG5pbXBvcnQgKiBhcyBjdXN0b21NYXRjaGVycyBmcm9tICcuLi9tYXRjaGVycyc7XG5pbXBvcnQgeyBhZGRNYXRjaGVycyB9IGZyb20gJy4uL2NvcmUnO1xuaW1wb3J0IHsgaXNUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgSG9zdENvbXBvbmVudCB9IGZyb20gJy4uL3NwZWN0YXRvci1ob3N0L2hvc3QtY29tcG9uZW50JztcbmltcG9ydCB7IEJhc2VTcGVjdGF0b3JPdmVycmlkZXMgfSBmcm9tICcuLi9iYXNlL29wdGlvbnMnO1xuaW1wb3J0IHsgbm9kZUJ5RGlyZWN0aXZlIH0gZnJvbSAnLi4vaW50ZXJuYWxzL25vZGUtYnktZGlyZWN0aXZlJztcblxuaW1wb3J0IHsgaW5pdGlhbFNwZWN0YXRvckRpcmVjdGl2ZU1vZHVsZSB9IGZyb20gJy4vaW5pdGlhbC1tb2R1bGUnO1xuaW1wb3J0IHsgZ2V0U3BlY3RhdG9yRGlyZWN0aXZlRGVmYXVsdE9wdGlvbnMsIFNwZWN0YXRvckRpcmVjdGl2ZU9wdGlvbnMgfSBmcm9tICcuL29wdGlvbnMnO1xuaW1wb3J0IHsgU3BlY3RhdG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9zcGVjdGF0b3ItZGlyZWN0aXZlJztcbmltcG9ydCB7IG92ZXJyaWRlTW9kdWxlcyB9IGZyb20gJy4uL3NwZWN0YXRvci9jcmVhdGUtZmFjdG9yeSc7XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgdHlwZSBTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+ID0gPEhQPihcbiAgdGVtcGxhdGU6IHN0cmluZyxcbiAgb3ZlcnJpZGVzPzogU3BlY3RhdG9yRGlyZWN0aXZlT3ZlcnJpZGVzPEQsIEgsIEhQPlxuKSA9PiBTcGVjdGF0b3JEaXJlY3RpdmU8RCwgSCAmIChIb3N0Q29tcG9uZW50IGV4dGVuZHMgSCA/IEhQIDogdW5rbm93bik+O1xuXG4vKipcbiAqIEBwdWJsaWNBcGlcbiAqL1xuZXhwb3J0IHR5cGUgUHJlc2V0U3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPiA9IDxIUD4oXG4gIHRlbXBsYXRlPzogc3RyaW5nLFxuICBvdmVycmlkZXM/OiBTcGVjdGF0b3JEaXJlY3RpdmVPdmVycmlkZXM8RCwgSCwgSFA+XG4pID0+IFNwZWN0YXRvckRpcmVjdGl2ZTxELCBIICYgKEhvc3RDb21wb25lbnQgZXh0ZW5kcyBIID8gSFAgOiB1bmtub3duKT47XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD4gZXh0ZW5kcyBCYXNlU3BlY3RhdG9yT3ZlcnJpZGVzIHtcbiAgZGV0ZWN0Q2hhbmdlcz86IGJvb2xlYW47XG4gIHByb3BzPzogUGFydGlhbDxEPjtcbiAgaG9zdFByb3BzPzogSG9zdENvbXBvbmVudCBleHRlbmRzIEggPyBIUCA6IFBhcnRpYWw8SD47XG4gIGRpcmVjdGl2ZVByb3ZpZGVycz86IFByb3ZpZGVyW107XG59XG5cbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGlyZWN0aXZlRmFjdG9yeTxELCBIID0gSG9zdENvbXBvbmVudD4oXG4gIG9wdGlvbnM6IFNwZWN0YXRvckRpcmVjdGl2ZU9wdGlvbnM8RCwgSD4gJiB7IHRlbXBsYXRlOiBzdHJpbmcgfVxuKTogUHJlc2V0U3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPjtcbi8qKlxuICogQHB1YmxpY0FwaVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlRGlyZWN0aXZlRmFjdG9yeTxELCBIID0gSG9zdENvbXBvbmVudD4oXG4gIHR5cGVPck9wdGlvbnM6IFR5cGU8RD4gfCBTcGVjdGF0b3JEaXJlY3RpdmVPcHRpb25zPEQsIEg+XG4pOiBTcGVjdGF0b3JEaXJlY3RpdmVGYWN0b3J5PEQsIEg+O1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURpcmVjdGl2ZUZhY3Rvcnk8RCwgSCA9IEhvc3RDb21wb25lbnQ+KFxuICB0eXBlT3JPcHRpb25zOiBUeXBlPEQ+IHwgU3BlY3RhdG9yRGlyZWN0aXZlT3B0aW9uczxELCBIPlxuKTogU3BlY3RhdG9yRGlyZWN0aXZlRmFjdG9yeTxELCBIPiB7XG4gIGNvbnN0IG9wdGlvbnMgPSBpc1R5cGUodHlwZU9yT3B0aW9ucylcbiAgICA/IGdldFNwZWN0YXRvckRpcmVjdGl2ZURlZmF1bHRPcHRpb25zPEQsIEg+KHsgZGlyZWN0aXZlOiB0eXBlT3JPcHRpb25zIH0pXG4gICAgOiBnZXRTcGVjdGF0b3JEaXJlY3RpdmVEZWZhdWx0T3B0aW9ucyh0eXBlT3JPcHRpb25zKTtcblxuICBjb25zdCBtb2R1bGVNZXRhZGF0YSA9IGluaXRpYWxTcGVjdGF0b3JEaXJlY3RpdmVNb2R1bGU8RCwgSD4ob3B0aW9ucyk7XG5cbiAgYmVmb3JlRWFjaChhc3luYygoKSA9PiB7XG4gICAgYWRkTWF0Y2hlcnMoY3VzdG9tTWF0Y2hlcnMpO1xuICAgIFRlc3RCZWQuY29uZmlndXJlVGVzdGluZ01vZHVsZShtb2R1bGVNZXRhZGF0YSk7XG4gICAgb3ZlcnJpZGVNb2R1bGVzKG9wdGlvbnMpO1xuICB9KSk7XG5cbiAgcmV0dXJuIDxIUD4odGVtcGxhdGU/OiBzdHJpbmcsIG92ZXJyaWRlcz86IFNwZWN0YXRvckRpcmVjdGl2ZU92ZXJyaWRlczxELCBILCBIUD4pID0+IHtcbiAgICBjb25zdCBkZWZhdWx0czogU3BlY3RhdG9yRGlyZWN0aXZlT3ZlcnJpZGVzPEQsIEgsIEhQPiA9IHtcbiAgICAgIHByb3BzOiB7fSxcbiAgICAgIGhvc3RQcm9wczoge30gYXMgYW55LFxuICAgICAgZGV0ZWN0Q2hhbmdlczogdHJ1ZSxcbiAgICAgIHByb3ZpZGVyczogW11cbiAgICB9O1xuICAgIGNvbnN0IHsgZGV0ZWN0Q2hhbmdlcywgcHJvcHMsIGhvc3RQcm9wcywgcHJvdmlkZXJzIH0gPSB7IC4uLmRlZmF1bHRzLCAuLi5vdmVycmlkZXMgfTtcblxuICAgIGlmIChwcm92aWRlcnMgJiYgcHJvdmlkZXJzLmxlbmd0aCkge1xuICAgICAgcHJvdmlkZXJzLmZvckVhY2goKHByb3ZpZGVyOiBQcm92aWRlcikgPT4ge1xuICAgICAgICBUZXN0QmVkLm92ZXJyaWRlUHJvdmlkZXIoKHByb3ZpZGVyIGFzIGFueSkucHJvdmlkZSwgcHJvdmlkZXIgYXMgYW55KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIFRlc3RCZWQub3ZlcnJpZGVNb2R1bGUoQnJvd3NlckR5bmFtaWNUZXN0aW5nTW9kdWxlLCB7XG4gICAgICBzZXQ6IHtcbiAgICAgICAgZW50cnlDb21wb25lbnRzOiBtb2R1bGVNZXRhZGF0YS5lbnRyeUNvbXBvbmVudHNcbiAgICAgIH1cbiAgICB9KS5vdmVycmlkZUNvbXBvbmVudChvcHRpb25zLmhvc3QsIHtcbiAgICAgIHNldDogeyB0ZW1wbGF0ZTogdGVtcGxhdGUgfHwgb3B0aW9ucy50ZW1wbGF0ZSB9XG4gICAgfSk7XG5cbiAgICBpZiAob3B0aW9ucy5kaXJlY3RpdmVQcm92aWRlcnMubGVuZ3RoIHx8IG9wdGlvbnMuZGlyZWN0aXZlTW9ja3MubGVuZ3RoKSB7XG4gICAgICBUZXN0QmVkLm92ZXJyaWRlRGlyZWN0aXZlKG9wdGlvbnMuZGlyZWN0aXZlLCB7XG4gICAgICAgIHNldDogeyBwcm92aWRlcnM6IFsuLi5vcHRpb25zLmRpcmVjdGl2ZVByb3ZpZGVycywgLi4ub3B0aW9ucy5kaXJlY3RpdmVNb2Nrcy5tYXAocCA9PiBvcHRpb25zLm1vY2tQcm92aWRlcihwKSldIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNwZWN0YXRvciA9IGNyZWF0ZVNwZWN0YXRvckRpcmVjdGl2ZShvcHRpb25zLCBwcm9wcywgaG9zdFByb3BzKTtcblxuICAgIGlmIChvcHRpb25zLmRldGVjdENoYW5nZXMgJiYgZGV0ZWN0Q2hhbmdlcykge1xuICAgICAgc3BlY3RhdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3BlY3RhdG9yO1xuICB9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTcGVjdGF0b3JEaXJlY3RpdmU8RCwgSCwgSFA+KFxuICBvcHRpb25zOiBSZXF1aXJlZDxTcGVjdGF0b3JEaXJlY3RpdmVPcHRpb25zPEQsIEg+PixcbiAgcHJvcHM/OiBQYXJ0aWFsPEQ+LFxuICBob3N0UHJvcHM/OiBIUFxuKTogU3BlY3RhdG9yRGlyZWN0aXZlPEQsIEggJiBIUD4ge1xuICBjb25zdCBob3N0Rml4dHVyZSA9IFRlc3RCZWQuY3JlYXRlQ29tcG9uZW50KG9wdGlvbnMuaG9zdCk7XG4gIGNvbnN0IGRlYnVnRWxlbWVudCA9IGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudC5xdWVyeShCeS5kaXJlY3RpdmUob3B0aW9ucy5kaXJlY3RpdmUpKSB8fCBob3N0Rml4dHVyZS5kZWJ1Z0VsZW1lbnQ7XG4gIGNvbnN0IGRlYnVnTm9kZSA9IGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudC5xdWVyeUFsbE5vZGVzKG5vZGVCeURpcmVjdGl2ZShvcHRpb25zLmRpcmVjdGl2ZSkpWzBdO1xuXG4gIGlmICghZGVidWdOb2RlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCBkaXJlY3RpdmUgJHtvcHRpb25zLmRpcmVjdGl2ZX0gaW4gaG9zdCB0ZW1wbGF0ZSDwn5iUYCk7XG4gIH1cblxuICBjb25zdCBob3N0Q29tcG9uZW50ID0gc2V0UHJvcHMoaG9zdEZpeHR1cmUuY29tcG9uZW50SW5zdGFuY2UsIGhvc3RQcm9wcyk7XG4gIGNvbnN0IGRpcmVjdGl2ZSA9IHNldFByb3BzKGRlYnVnTm9kZS5pbmplY3Rvci5nZXQob3B0aW9ucy5kaXJlY3RpdmUpLCBwcm9wcyk7XG5cbiAgcmV0dXJuIG5ldyBTcGVjdGF0b3JEaXJlY3RpdmUoaG9zdENvbXBvbmVudCwgaG9zdEZpeHR1cmUsIGhvc3RGaXh0dXJlLmRlYnVnRWxlbWVudCwgZGlyZWN0aXZlLCBkZWJ1Z0VsZW1lbnQubmF0aXZlRWxlbWVudCk7XG59XG4iXX0=