import { ChangeDetectorRef, DebugElement, ElementRef } from '@angular/core';
import { Observable } from 'rxjs';
import { tick } from '@angular/core/testing';
import { By } from '@angular/platform-browser';
import { DOMSelector } from '../dom-selectors';
import { isString } from '../types';
import { getChildren, setProps } from '../internals/query';
import { patchElementFocus } from '../internals/element-focus';
import { createMouseEvent } from '../event-creators';
import { dispatchFakeEvent, dispatchKeyboardEvent, dispatchMouseEvent, dispatchTouchEvent } from '../dispatch-events';
import { typeInElement } from '../type-in-element';
import { selectOption } from '../select-option';
import { BaseSpectator } from './base-spectator';
const KEY_UP = 'keyup';
/**
 * @internal
 */
export class DomSpectator extends BaseSpectator {
    constructor(fixture, debugElement, instance, element) {
        super();
        this.fixture = fixture;
        this.debugElement = debugElement;
        this.instance = instance;
        this.element = element;
    }
    inject(token) {
        return super.inject(token);
    }
    detectChanges() {
        this.fixture.detectChanges();
    }
    query(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return document.querySelector(directiveOrSelector);
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document)[0] || null;
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options)[0] || null;
    }
    queryAll(directiveOrSelector, options) {
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                return Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                return directiveOrSelector.execute(document);
            }
        }
        return getChildren(this.debugElement)(directiveOrSelector, options);
    }
    queryLast(directiveOrSelector, options) {
        let result = [];
        if ((options || {}).root) {
            if (isString(directiveOrSelector)) {
                result = Array.from(document.querySelectorAll(directiveOrSelector));
            }
            if (directiveOrSelector instanceof DOMSelector) {
                result = directiveOrSelector.execute(document);
            }
        }
        else {
            result = getChildren(this.debugElement)(directiveOrSelector, options);
        }
        if (result && result.length) {
            return result[result.length - 1];
        }
        return null;
    }
    setInput(input, value) {
        setProps(this.instance, input, value, false);
        this.debugElement.injector.get(ChangeDetectorRef).detectChanges();
    }
    output(output) {
        const observable = this.instance[output];
        if (!(observable instanceof Observable)) {
            throw new Error(`${output} is not an @Output`);
        }
        return observable;
    }
    tick(millis) {
        tick(millis);
        this.detectChanges();
    }
    click(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot click: ${selector} is not a HTMLElement`);
        }
        element.click();
        this.detectChanges();
    }
    blur(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot blur: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.blur();
        this.detectChanges();
    }
    focus(selector = this.element) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof HTMLElement)) {
            throw new Error(`Cannot focus: ${selector} is not a HTMLElement`);
        }
        patchElementFocus(element);
        element.focus();
        this.detectChanges();
    }
    dispatchMouseEvent(selector = this.element, type, x = 0, y = 0, event = createMouseEvent(type, x, y)) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch mouse event: ${selector} is not a node`);
        }
        const dispatchedEvent = dispatchMouseEvent(element, type, x, y, event);
        this.detectChanges();
        return dispatchedEvent;
    }
    dispatchKeyboardEvent(selector = this.element, type, keyOrKeyCode, target) {
        const element = this.getNativeElement(selector);
        if (!(element instanceof Node)) {
            throw new Error(`Cannot dispatch keyboard event: ${selector} is not a node`);
        }
        const event = dispatchKeyboardEvent(element, type, keyOrKeyCode, target);
        this.detectChanges();
        return event;
    }
    dispatchFakeEvent(selector = this.element, type, canBubble) {
        const event = dispatchFakeEvent(this.getNativeElement(selector), type, canBubble);
        this.detectChanges();
        return event;
    }
    triggerEventHandler(directiveOrSelector, eventName, eventObj) {
        const debugElement = this.getDebugElement(directiveOrSelector);
        if (!debugElement) {
            // tslint:disable:no-console
            console.error(`${directiveOrSelector} does not exists`);
            return;
        }
        debugElement.triggerEventHandler(eventName, eventObj);
        this.detectChanges();
    }
    get keyboard() {
        return {
            pressKey: (key, selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, key);
            },
            pressEscape: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Escape', keyCode: 27 });
            },
            pressEnter: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Enter', keyCode: 13 });
            },
            pressTab: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Tab', keyCode: 9 });
            },
            pressBackspace: (selector = this.element, event = KEY_UP) => {
                this.dispatchKeyboardEvent(selector, event, { key: 'Backspace', keyCode: 8 });
            }
        };
    }
    get mouse() {
        return {
            contextmenu: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'contextmenu');
            },
            dblclick: (selector = this.element) => {
                this.dispatchMouseEvent(selector, 'dblclick');
            }
        };
    }
    dispatchTouchEvent(selector = this.element, type, x = 0, y = 0) {
        dispatchTouchEvent(this.getNativeElement(selector), type, x, y);
        this.detectChanges();
    }
    typeInElement(value, selector = this.element) {
        typeInElement(value, this.getNativeElement(selector));
        this.detectChanges();
    }
    selectOption(selector = this.element, options, config = { emitEvents: true }) {
        if (!selector) {
            throw new Error(`Cannot find select: ${selector}`);
        }
        selectOption(options, this.getNativeElement(selector), config);
        this.detectChanges();
    }
    getNativeElement(selector) {
        let element;
        // Support global objects window and document
        if (selector === window || selector === document) {
            return selector;
        }
        if (isString(selector)) {
            const exists = this.debugElement.query(By.css(selector));
            if (exists) {
                element = exists.nativeElement;
            }
            else {
                // tslint:disable:no-console
                console.error(`${selector} does not exists`);
            }
        }
        else if (selector instanceof DOMSelector) {
            element = selector.execute(document)[0] || null;
        }
        else {
            if (selector instanceof DebugElement || selector instanceof ElementRef) {
                element = selector.nativeElement;
            }
            else {
                element = selector;
            }
        }
        return element;
    }
    getDebugElement(directiveOrSelector) {
        let debugElement;
        if (isString(directiveOrSelector)) {
            debugElement = this.debugElement.query(By.css(directiveOrSelector));
        }
        else if (directiveOrSelector instanceof DebugElement) {
            debugElement = directiveOrSelector;
        }
        else {
            debugElement = this.debugElement.query(By.directive(directiveOrSelector));
        }
        return debugElement;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLXNwZWN0YXRvci5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvbmV0YW5lbGJhc2FsL3d3dy9zcGVjdGF0b3IvcHJvamVjdHMvc3BlY3RhdG9yL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9iYXNlL2RvbS1zcGVjdGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBRSxVQUFVLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEMsT0FBTyxFQUFvQixJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFHL0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxRQUFRLEVBQW1HLE1BQU0sVUFBVSxDQUFDO0FBRXJJLE9BQU8sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDM0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLHFCQUFxQixFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDdEgsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFakQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDO0FBRXZCOztHQUVHO0FBQ0gsTUFBTSxPQUFnQixZQUFnQixTQUFRLGFBQWE7SUFDekQsWUFBbUIsT0FBOEIsRUFB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QUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7U0FDM0U7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3RvclJlZiwgRGVidWdFbGVtZW50LCBFbGVtZW50UmVmLCBUeXBlLCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvbXBvbmVudEZpeHR1cmUsIHRpY2sgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQnkgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcblxuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICcuLi90b2tlbic7XG5pbXBvcnQgeyBET01TZWxlY3RvciB9IGZyb20gJy4uL2RvbS1zZWxlY3RvcnMnO1xuaW1wb3J0IHsgaXNTdHJpbmcsIFF1ZXJ5T3B0aW9ucywgUXVlcnlUeXBlLCBTcGVjdGF0b3JFbGVtZW50LCBFdmVudEVtaXR0ZXJUeXBlLCBLZXlzTWF0Y2hpbmcsIEtleWJvYXJkRXZlbnRPcHRpb25zIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU3B5T2JqZWN0IH0gZnJvbSAnLi4vbW9jayc7XG5pbXBvcnQgeyBnZXRDaGlsZHJlbiwgc2V0UHJvcHMgfSBmcm9tICcuLi9pbnRlcm5hbHMvcXVlcnknO1xuaW1wb3J0IHsgcGF0Y2hFbGVtZW50Rm9jdXMgfSBmcm9tICcuLi9pbnRlcm5hbHMvZWxlbWVudC1mb2N1cyc7XG5pbXBvcnQgeyBjcmVhdGVNb3VzZUV2ZW50IH0gZnJvbSAnLi4vZXZlbnQtY3JlYXRvcnMnO1xuaW1wb3J0IHsgZGlzcGF0Y2hGYWtlRXZlbnQsIGRpc3BhdGNoS2V5Ym9hcmRFdmVudCwgZGlzcGF0Y2hNb3VzZUV2ZW50LCBkaXNwYXRjaFRvdWNoRXZlbnQgfSBmcm9tICcuLi9kaXNwYXRjaC1ldmVudHMnO1xuaW1wb3J0IHsgdHlwZUluRWxlbWVudCB9IGZyb20gJy4uL3R5cGUtaW4tZWxlbWVudCc7XG5pbXBvcnQgeyBzZWxlY3RPcHRpb24gfSBmcm9tICcuLi9zZWxlY3Qtb3B0aW9uJztcblxuaW1wb3J0IHsgQmFzZVNwZWN0YXRvciB9IGZyb20gJy4vYmFzZS1zcGVjdGF0b3InO1xuXG5jb25zdCBLRVlfVVAgPSAna2V5dXAnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRG9tU3BlY3RhdG9yPEk+IGV4dGVuZHMgQmFzZVNwZWN0YXRvciB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBmaXh0dXJlOiBDb21wb25lbnRGaXh0dXJlPGFueT4sIHB1YmxpYyBkZWJ1Z0VsZW1lbnQ6IERlYnVnRWxlbWVudCwgcHJvdGVjdGVkIGluc3RhbmNlOiBJLCBwdWJsaWMgZWxlbWVudDogRWxlbWVudCkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBwdWJsaWMgaW5qZWN0PFQ+KHRva2VuOiBUb2tlbjxUPik6IFNweU9iamVjdDxUPiB7XG4gICAgcmV0dXJuIHN1cGVyLmluamVjdCh0b2tlbik7XG4gIH1cblxuICBwdWJsaWMgZGV0ZWN0Q2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLmZpeHR1cmUuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5PFIgZXh0ZW5kcyBFbGVtZW50PihzZWxlY3Rvcjogc3RyaW5nIHwgRE9NU2VsZWN0b3IsIG9wdGlvbnM/OiB7IHJvb3Q6IGJvb2xlYW4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnk8Uj4oZGlyZWN0aXZlOiBUeXBlPFI+KTogUiB8IG51bGw7XG4gIHB1YmxpYyBxdWVyeTxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPGFueT4gfCBzdHJpbmcsIG9wdGlvbnM6IHsgcmVhZDogVG9rZW48Uj4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnk8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogUXVlcnlUeXBlLCBvcHRpb25zPzogUXVlcnlPcHRpb25zPFI+KTogUiB8IEVsZW1lbnQgfCBudWxsIHtcbiAgICBpZiAoKG9wdGlvbnMgfHwge30pLnJvb3QpIHtcbiAgICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihkaXJlY3RpdmVPclNlbGVjdG9yKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpcmVjdGl2ZU9yU2VsZWN0b3IgaW5zdGFuY2VvZiBET01TZWxlY3Rvcikge1xuICAgICAgICByZXR1cm4gZGlyZWN0aXZlT3JTZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSlbMF0gfHwgbnVsbDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZ2V0Q2hpbGRyZW48Uj4odGhpcy5kZWJ1Z0VsZW1lbnQpKGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpWzBdIHx8IG51bGw7XG4gIH1cblxuICBwdWJsaWMgcXVlcnlBbGw8UiBleHRlbmRzIEVsZW1lbnQ+KHNlbGVjdG9yOiBzdHJpbmcgfCBET01TZWxlY3Rvciwgb3B0aW9ucz86IHsgcm9vdDogYm9vbGVhbiB9KTogUltdO1xuICBwdWJsaWMgcXVlcnlBbGw8Uj4oZGlyZWN0aXZlOiBUeXBlPFI+KTogUltdO1xuICBwdWJsaWMgcXVlcnlBbGw8Uj4oZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxhbnk+IHwgc3RyaW5nLCBvcHRpb25zOiB7IHJlYWQ6IFRva2VuPFI+IH0pOiBSW107XG4gIHB1YmxpYyBxdWVyeUFsbDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBRdWVyeVR5cGUsIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnM8Uj4pOiBSW10gfCBFbGVtZW50W10ge1xuICAgIGlmICgob3B0aW9ucyB8fCB7fSkucm9vdCkge1xuICAgICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiBkaXJlY3RpdmVPclNlbGVjdG9yLmV4ZWN1dGUoZG9jdW1lbnQgYXMgYW55KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZ2V0Q2hpbGRyZW48Uj4odGhpcy5kZWJ1Z0VsZW1lbnQpKGRpcmVjdGl2ZU9yU2VsZWN0b3IsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5TGFzdDxSIGV4dGVuZHMgRWxlbWVudD4oc2VsZWN0b3I6IHN0cmluZyB8IERPTVNlbGVjdG9yLCBvcHRpb25zPzogeyByb290OiBib29sZWFuIH0pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5TGFzdDxSPihkaXJlY3RpdmU6IFR5cGU8Uj4pOiBSIHwgbnVsbDtcbiAgcHVibGljIHF1ZXJ5TGFzdDxSPihkaXJlY3RpdmVPclNlbGVjdG9yOiBUeXBlPGFueT4gfCBzdHJpbmcsIG9wdGlvbnM6IHsgcmVhZDogVG9rZW48Uj4gfSk6IFIgfCBudWxsO1xuICBwdWJsaWMgcXVlcnlMYXN0PFI+KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IFF1ZXJ5VHlwZSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9uczxSPik6IFIgfCBFbGVtZW50IHwgbnVsbCB7XG4gICAgbGV0IHJlc3VsdDogKFIgfCBFbGVtZW50KVtdID0gW107XG5cbiAgICBpZiAoKG9wdGlvbnMgfHwge30pLnJvb3QpIHtcbiAgICAgIGlmIChpc1N0cmluZyhkaXJlY3RpdmVPclNlbGVjdG9yKSkge1xuICAgICAgICByZXN1bHQgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERPTVNlbGVjdG9yKSB7XG4gICAgICAgIHJlc3VsdCA9IGRpcmVjdGl2ZU9yU2VsZWN0b3IuZXhlY3V0ZShkb2N1bWVudCBhcyBhbnkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBnZXRDaGlsZHJlbjxSPih0aGlzLmRlYnVnRWxlbWVudCkoZGlyZWN0aXZlT3JTZWxlY3Rvciwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBzZXRJbnB1dDxLIGV4dGVuZHMga2V5b2YgST4oaW5wdXQ6IFBhcnRpYWw8ST4pOiB2b2lkO1xuICBwdWJsaWMgc2V0SW5wdXQ8SyBleHRlbmRzIGtleW9mIEk+KGlucHV0OiBLLCBpbnB1dFZhbHVlOiBJW0tdKTogdm9pZDtcbiAgcHVibGljIHNldElucHV0KGlucHV0OiBhbnksIHZhbHVlPzogYW55KTogdm9pZCB7XG4gICAgc2V0UHJvcHModGhpcy5pbnN0YW5jZSwgaW5wdXQsIHZhbHVlLCBmYWxzZSk7XG4gICAgdGhpcy5kZWJ1Z0VsZW1lbnQuaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmKS5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgb3V0cHV0PFQsIEsgZXh0ZW5kcyBrZXlvZiBJID0ga2V5b2YgST4ob3V0cHV0OiBLKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHRoaXMuaW5zdGFuY2Vbb3V0cHV0XTtcblxuICAgIGlmICghKG9ic2VydmFibGUgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke291dHB1dH0gaXMgbm90IGFuIEBPdXRwdXRgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2JzZXJ2YWJsZSBhcyBPYnNlcnZhYmxlPFQ+O1xuICB9XG5cbiAgcHVibGljIHRpY2sobWlsbGlzPzogbnVtYmVyKTogdm9pZCB7XG4gICAgdGljayhtaWxsaXMpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGNsaWNrKHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjbGljazogJHtzZWxlY3Rvcn0gaXMgbm90IGEgSFRNTEVsZW1lbnRgKTtcbiAgICB9XG5cbiAgICBlbGVtZW50LmNsaWNrKCk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgYmx1cihzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgYmx1cjogJHtzZWxlY3Rvcn0gaXMgbm90IGEgSFRNTEVsZW1lbnRgKTtcbiAgICB9XG5cbiAgICBwYXRjaEVsZW1lbnRGb2N1cyhlbGVtZW50KTtcbiAgICBlbGVtZW50LmJsdXIoKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBmb2N1cyhzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZm9jdXM6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIEhUTUxFbGVtZW50YCk7XG4gICAgfVxuXG4gICAgcGF0Y2hFbGVtZW50Rm9jdXMoZWxlbWVudCk7XG4gICAgZWxlbWVudC5mb2N1cygpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIGRpc3BhdGNoTW91c2VFdmVudChcbiAgICBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICB0eXBlOiBzdHJpbmcsXG4gICAgeDogbnVtYmVyID0gMCxcbiAgICB5OiBudW1iZXIgPSAwLFxuICAgIGV2ZW50OiBNb3VzZUV2ZW50ID0gY3JlYXRlTW91c2VFdmVudCh0eXBlLCB4LCB5KVxuICApOiBNb3VzZUV2ZW50IHtcbiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKTtcblxuICAgIGlmICghKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZGlzcGF0Y2ggbW91c2UgZXZlbnQ6ICR7c2VsZWN0b3J9IGlzIG5vdCBhIG5vZGVgKTtcbiAgICB9XG5cbiAgICBjb25zdCBkaXNwYXRjaGVkRXZlbnQgPSBkaXNwYXRjaE1vdXNlRXZlbnQoZWxlbWVudCwgdHlwZSwgeCwgeSwgZXZlbnQpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgcmV0dXJuIGRpc3BhdGNoZWRFdmVudDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQsIHR5cGU6IHN0cmluZywga2V5Q29kZTogbnVtYmVyLCB0YXJnZXQ/OiBFbGVtZW50KTogS2V5Ym9hcmRFdmVudDtcbiAgcHVibGljIGRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCwgdHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZywgdGFyZ2V0PzogRWxlbWVudCk6IEtleWJvYXJkRXZlbnQ7XG4gIHB1YmxpYyBkaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQsIHR5cGU6IHN0cmluZywga2V5QW5kQ29kZTogS2V5Ym9hcmRFdmVudE9wdGlvbnMsIHRhcmdldD86IEVsZW1lbnQpOiBLZXlib2FyZEV2ZW50O1xuICBwdWJsaWMgZGlzcGF0Y2hLZXlib2FyZEV2ZW50KFxuICAgIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBrZXlPcktleUNvZGU6IHN0cmluZyB8IG51bWJlciB8IEtleWJvYXJkRXZlbnRPcHRpb25zLFxuICAgIHRhcmdldD86IEVsZW1lbnRcbiAgKTogS2V5Ym9hcmRFdmVudCB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3Rvcik7XG5cbiAgICBpZiAoIShlbGVtZW50IGluc3RhbmNlb2YgTm9kZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRpc3BhdGNoIGtleWJvYXJkIGV2ZW50OiAke3NlbGVjdG9yfSBpcyBub3QgYSBub2RlYCk7XG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnQgPSBkaXNwYXRjaEtleWJvYXJkRXZlbnQoZWxlbWVudCwgdHlwZSwga2V5T3JLZXlDb2RlLCB0YXJnZXQpO1xuXG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hGYWtlRXZlbnQoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsIHR5cGU6IHN0cmluZywgY2FuQnViYmxlPzogYm9vbGVhbik6IEV2ZW50IHtcbiAgICBjb25zdCBldmVudCA9IGRpc3BhdGNoRmFrZUV2ZW50KHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvciksIHR5cGUsIGNhbkJ1YmJsZSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4gZXZlbnQ7XG4gIH1cblxuICBwdWJsaWMgdHJpZ2dlckV2ZW50SGFuZGxlcjxDID0gYW55LCBLIGV4dGVuZHMgS2V5c01hdGNoaW5nPEMsIEV2ZW50RW1pdHRlcjxhbnk+PiA9IGFueT4oXG4gICAgZGlyZWN0aXZlT3JTZWxlY3RvcjogVHlwZTxDPiB8IHN0cmluZyB8IERlYnVnRWxlbWVudCxcbiAgICBldmVudE5hbWU6IEssXG4gICAgZXZlbnRPYmo6IEV2ZW50RW1pdHRlclR5cGU8Q1tLXT5cbiAgKSB7XG4gICAgY29uc3QgZGVidWdFbGVtZW50ID0gdGhpcy5nZXREZWJ1Z0VsZW1lbnQoZGlyZWN0aXZlT3JTZWxlY3Rvcik7XG4gICAgaWYgKCFkZWJ1Z0VsZW1lbnQpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlOm5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUuZXJyb3IoYCR7ZGlyZWN0aXZlT3JTZWxlY3Rvcn0gZG9lcyBub3QgZXhpc3RzYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGRlYnVnRWxlbWVudC50cmlnZ2VyRXZlbnRIYW5kbGVyKGV2ZW50TmFtZSBhcyBzdHJpbmcsIGV2ZW50T2JqKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQga2V5Ym9hcmQoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHByZXNzS2V5OiAoa2V5OiBzdHJpbmcsIHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCBldmVudCA9IEtFWV9VUCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3BhdGNoS2V5Ym9hcmRFdmVudChzZWxlY3RvciwgZXZlbnQsIGtleSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NFc2NhcGU6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0VzY2FwZScsIGtleUNvZGU6IDI3IH0pO1xuICAgICAgfSxcbiAgICAgIHByZXNzRW50ZXI6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0VudGVyJywga2V5Q29kZTogMTMgfSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NUYWI6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ1RhYicsIGtleUNvZGU6IDkgfSk7XG4gICAgICB9LFxuICAgICAgcHJlc3NCYWNrc3BhY2U6IChzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCwgZXZlbnQgPSBLRVlfVVApID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaEtleWJvYXJkRXZlbnQoc2VsZWN0b3IsIGV2ZW50LCB7IGtleTogJ0JhY2tzcGFjZScsIGtleUNvZGU6IDggfSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbW91c2UoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbnRleHRtZW51OiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaE1vdXNlRXZlbnQoc2VsZWN0b3IsICdjb250ZXh0bWVudScpO1xuICAgICAgfSxcbiAgICAgIGRibGNsaWNrOiAoc2VsZWN0b3I6IFNwZWN0YXRvckVsZW1lbnQgPSB0aGlzLmVsZW1lbnQpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaE1vdXNlRXZlbnQoc2VsZWN0b3IsICdkYmxjbGljaycpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgZGlzcGF0Y2hUb3VjaEV2ZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50ID0gdGhpcy5lbGVtZW50LCB0eXBlOiBzdHJpbmcsIHg6IG51bWJlciA9IDAsIHk6IG51bWJlciA9IDApOiB2b2lkIHtcbiAgICBkaXNwYXRjaFRvdWNoRXZlbnQodGhpcy5nZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yKSwgdHlwZSwgeCwgeSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwdWJsaWMgdHlwZUluRWxlbWVudCh2YWx1ZTogc3RyaW5nLCBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCk6IHZvaWQge1xuICAgIHR5cGVJbkVsZW1lbnQodmFsdWUsIHRoaXMuZ2V0TmF0aXZlRWxlbWVudChzZWxlY3RvcikpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHVibGljIHNlbGVjdE9wdGlvbihcbiAgICBzZWxlY3RvcjogU3BlY3RhdG9yRWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICBvcHRpb25zOiBzdHJpbmcgfCBzdHJpbmdbXSB8IEhUTUxPcHRpb25FbGVtZW50IHwgSFRNTE9wdGlvbkVsZW1lbnRbXSxcbiAgICBjb25maWc6IHsgZW1pdEV2ZW50czogYm9vbGVhbiB9ID0geyBlbWl0RXZlbnRzOiB0cnVlIH1cbiAgKTogdm9pZCB7XG4gICAgaWYgKCFzZWxlY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCBzZWxlY3Q6ICR7c2VsZWN0b3J9YCk7XG4gICAgfVxuICAgIHNlbGVjdE9wdGlvbihvcHRpb25zLCB0aGlzLmdldE5hdGl2ZUVsZW1lbnQoc2VsZWN0b3IpLCBjb25maWcpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROYXRpdmVFbGVtZW50KHNlbGVjdG9yOiBTcGVjdGF0b3JFbGVtZW50KTogSFRNTEVsZW1lbnQgfCBXaW5kb3cgfCBEb2N1bWVudCB7XG4gICAgbGV0IGVsZW1lbnQ7XG5cbiAgICAvLyBTdXBwb3J0IGdsb2JhbCBvYmplY3RzIHdpbmRvdyBhbmQgZG9jdW1lbnRcbiAgICBpZiAoc2VsZWN0b3IgPT09IHdpbmRvdyB8fCBzZWxlY3RvciA9PT0gZG9jdW1lbnQpIHtcbiAgICAgIHJldHVybiBzZWxlY3RvcjtcbiAgICB9XG5cbiAgICBpZiAoaXNTdHJpbmcoc2VsZWN0b3IpKSB7XG4gICAgICBjb25zdCBleGlzdHMgPSB0aGlzLmRlYnVnRWxlbWVudC5xdWVyeShCeS5jc3Moc2VsZWN0b3IpKTtcbiAgICAgIGlmIChleGlzdHMpIHtcbiAgICAgICAgZWxlbWVudCA9IGV4aXN0cy5uYXRpdmVFbGVtZW50O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGU6bm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmVycm9yKGAke3NlbGVjdG9yfSBkb2VzIG5vdCBleGlzdHNgKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHNlbGVjdG9yIGluc3RhbmNlb2YgRE9NU2VsZWN0b3IpIHtcbiAgICAgIGVsZW1lbnQgPSBzZWxlY3Rvci5leGVjdXRlKGRvY3VtZW50IGFzIGFueSlbMF0gfHwgbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHNlbGVjdG9yIGluc3RhbmNlb2YgRGVidWdFbGVtZW50IHx8IHNlbGVjdG9yIGluc3RhbmNlb2YgRWxlbWVudFJlZikge1xuICAgICAgICBlbGVtZW50ID0gc2VsZWN0b3IubmF0aXZlRWxlbWVudDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQgPSBzZWxlY3RvcjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGVidWdFbGVtZW50KGRpcmVjdGl2ZU9yU2VsZWN0b3I6IHN0cmluZyB8IERlYnVnRWxlbWVudCB8IFR5cGU8dW5rbm93bj4pIHtcbiAgICBsZXQgZGVidWdFbGVtZW50OiBEZWJ1Z0VsZW1lbnQ7XG4gICAgaWYgKGlzU3RyaW5nKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKSB7XG4gICAgICBkZWJ1Z0VsZW1lbnQgPSB0aGlzLmRlYnVnRWxlbWVudC5xdWVyeShCeS5jc3MoZGlyZWN0aXZlT3JTZWxlY3RvcikpO1xuICAgIH0gZWxzZSBpZiAoZGlyZWN0aXZlT3JTZWxlY3RvciBpbnN0YW5jZW9mIERlYnVnRWxlbWVudCkge1xuICAgICAgZGVidWdFbGVtZW50ID0gZGlyZWN0aXZlT3JTZWxlY3RvcjtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVidWdFbGVtZW50ID0gdGhpcy5kZWJ1Z0VsZW1lbnQucXVlcnkoQnkuZGlyZWN0aXZlKGRpcmVjdGl2ZU9yU2VsZWN0b3IpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRlYnVnRWxlbWVudDtcbiAgfVxufVxuIl19